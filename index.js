(function(g,I,p){"use strict";const l=p.findByProps("sendMessage","editMessage"),w=p.findByProps("promptToUpload"),b=p.findByStoreName("MessageStore");function F(r){const n=r instanceof File,o=n?URL.createObjectURL(r):r;return new Promise(function(a,i){const t=new Image;t.onload=function(){n&&URL.revokeObjectURL(o),a(t)},t.onerror=function(e,u,s,h,c){return i(c||e)},t.crossOrigin="Anonymous",t.src=o})}function U(r,n,o){const a=new Map,i=[],t=[];for(let s=0;s<r.length;s+=4){const h=r[s],c=r[s+1],d=r[s+2];r[s+3];const y=Math.floor(h/16)*16,v=Math.floor(c/16)*16,M=Math.floor(d/16)*16,m=`${y},${v},${M}`;!a.has(m)&&i.length<768&&(a.set(m,i.length/3),i.push(y,v,M)),t.push(a.get(m)||0)}for(;i.length<768;)i.push(0,0,0);const e=[];e.push(71,73,70,56,57,97),e.push(n&255,n>>8),e.push(o&255,o>>8),e.push(247),e.push(0),e.push(0),e.push(...i),e.push(33,249,4,1,0,0,0,0),e.push(44),e.push(0,0),e.push(0,0),e.push(n&255,n>>8),e.push(o&255,o>>8),e.push(0),e.push(8);const u=255;for(let s=0;s<t.length;s+=u){const h=Math.min(u,t.length-s);e.push(h);for(let c=0;c<h;c++)e.push(t[s+c])}return e.push(0),e.push(59),new Uint8Array(e)}async function S(r,n,o){const a=await F(r);let i,t;n&&o?(i=n,t=o):n?(i=n,t=Math.round(a.height/a.width*n)):o?(t=o,i=Math.round(a.width/a.height*o)):(i=a.width,t=a.height);const e=document.createElement("canvas");e.width=i,e.height=t;const u=e.getContext("2d");if(!u)throw new Error("Could not get canvas context");u.clearRect(0,0,e.width,e.height),u.drawImage(a,0,0,a.width,a.height,0,0,e.width,e.height);const s=u.getImageData(0,0,e.width,e.height),h=U(s.data,e.width,e.height),c=r.name?r.name.replace(/\.[^/.]+$/,""):"converted";return new File([h],`${c}.gif`,{type:"image/gif"})}let f;var C={onLoad:function(){f=I.registerCommand({name:"imgtogif",displayName:"Image to GIF",description:"Convert the last image in chat to GIF format",options:[{name:"width",displayName:"width",description:"Width of the output GIF (optional)",required:!1,type:4},{name:"height",displayName:"height",description:"Height of the output GIF (optional)",required:!1,type:4}],execute:async function(r,n){try{let o,a;for(const h of r)h.name==="width"?o=Number(h.value):h.name==="height"&&(a=Number(h.value));const i=b?.getMessages?.(n.channel.id)?._array||[];let t=null;for(let h=i.length-1;h>=0;h--){const c=i[h];if(c.attachments&&c.attachments.length>0){for(const d of c.attachments)if(d.content_type?.startsWith("image/")||d.filename?.match(/\.(png|jpg|jpeg|gif|webp)$/i)){t=d;break}}if(t)break}if(!t){l.sendMessage(n.channel.id,{content:"\u274C No image found in recent messages! Please send an image first."},void 0,{nonce:Date.now().toString()});return}l.sendMessage(n.channel.id,{content:"\u{1F504} Converting to GIF..."},void 0,{nonce:Date.now().toString()});const e=await(await fetch(t.url)).blob(),u=new File([e],t.filename||"image.png",{type:e.type}),s=await S(u,o,a);w?.promptToUpload?setTimeout(function(){w.promptToUpload([s],n.channel,0)},10):l.sendMessage(n.channel.id,{content:"\u2705 GIF created! (Upload handler not available)"},void 0,{nonce:Date.now().toString()})}catch(o){console.error("[ImgToGif] Error:",o),l.sendMessage(n.channel.id,{content:`\u274C Error: ${String(o)}`},void 0,{nonce:Date.now().toString()})}},applicationId:"-1",inputType:1,type:1})},onUnload:function(){f&&f()}};return g.default=C,Object.defineProperty(g,"__esModule",{value:!0}),g})({},vendetta.commands,vendetta.metro);
