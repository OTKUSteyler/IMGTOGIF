(function(m,U,f){"use strict";const p=f.findByProps("sendMessage","editMessage"),v=f.findByProps("promptToUpload"),I=f.findByStoreName("MessageStore");function b(s){const n=s instanceof File,t=n?URL.createObjectURL(s):s;return new Promise(function(o,c){const a=new Image;a.onload=function(){n&&URL.revokeObjectURL(t),o(a)},a.onerror=function(e,l,r,i,h){return c(h||e)},a.crossOrigin="Anonymous",a.src=t})}function F(s,n,t){const o=new Map,c=[],a=[];for(let r=0;r<s.length;r+=4){const i=s[r],h=s[r+1],g=s[r+2],u=Math.floor(i/16)*16,d=Math.floor(h/16)*16,M=Math.floor(g/16)*16,y=`${u},${d},${M}`;!o.has(y)&&c.length<768&&(o.set(y,c.length/3),c.push(u,d,M)),a.push(o.get(y)||0)}for(;c.length<768;)c.push(0,0,0);const e=[];e.push(71,73,70,56,57,97),e.push(n&255,n>>8),e.push(t&255,t>>8),e.push(247,0,0),e.push(...c),e.push(33,249,4,1,0,0,0,0),e.push(44,0,0,0,0),e.push(n&255,n>>8),e.push(t&255,t>>8),e.push(0,8);const l=255;for(let r=0;r<a.length;r+=l){const i=Math.min(l,a.length-r);e.push(i);for(let h=0;h<i;h++)e.push(a[r+h])}return e.push(0,59),new Uint8Array(e)}async function R(s,n,t){const o=await b(s);let c=n&&t?n:n||(t?Math.round(o.width/o.height*t):o.width),a=n&&t?t:t||(n?Math.round(o.height/o.width*n):o.height);const e=document.createElement("canvas");e.width=c,e.height=a;const l=e.getContext("2d");if(!l)throw new Error("Could not get canvas context");l.clearRect(0,0,e.width,e.height),l.drawImage(o,0,0,o.width,o.height,0,0,e.width,e.height);const r=l.getImageData(0,0,e.width,e.height),i=F(r.data,e.width,e.height),h=s.name?s.name.replace(/\.[^/.]+$/,""):"converted";return new File([i],`${h}.gif`,{type:"image/gif"})}let w;var G={onLoad:function(){w=U.registerCommand({name:"imgtogif",displayName:"Image to GIF",description:"Convert image to GIF. Uses last image in chat, or provide url:IMAGE_URL",options:[{name:"url",displayName:"url",description:"Image URL (optional - uses last image if omitted)",required:!1,type:3},{name:"width",displayName:"width",description:"Width of output GIF (optional)",required:!1,type:4},{name:"height",displayName:"height",description:"Height of output GIF (optional)",required:!1,type:4}],execute:async function(s,n){try{let t=null,o,c;for(const i of s)i.name==="url"?t=i.value:i.name==="width"?o=Number(i.value):i.name==="height"&&(c=Number(i.value));if(!t){const i=I?.getMessages?.(n.channel.id)?._array||[];let h=null;for(let g=i.length-1;g>=0;g--){const u=i[g];if(u.attachments&&u.attachments.length>0){for(const d of u.attachments)if(d.content_type?.startsWith("image/")||d.filename?.match(/\.(png|jpg|jpeg|gif|webp)$/i)){h=d;break}}if(h)break}if(!h){p.sendMessage(n.channel.id,{content:"\u274C No image found! Send an image first or use: /imgtogif url:YOUR_URL"},void 0,{nonce:Date.now().toString()});return}t=h.url}p.sendMessage(n.channel.id,{content:"\u{1F504} Converting to GIF..."},void 0,{nonce:Date.now().toString()});const a=await(await fetch(t)).blob(),e=t.split("/").pop()||"image.png",l=new File([a],e,{type:a.type}),r=await R(l,o,c);v?.promptToUpload?setTimeout(function(){v.promptToUpload([r],n.channel,0)},10):p.sendMessage(n.channel.id,{content:"\u2705 GIF created! (Upload handler not available)"},void 0,{nonce:Date.now().toString()})}catch(t){console.error("[ImgToGif] Error:",t),p.sendMessage(n.channel.id,{content:`\u274C Error: ${String(t)}`},void 0,{nonce:Date.now().toString()})}},applicationId:"-1",inputType:1,type:1})},onUnload:function(){w&&w()}};return m.default=G,Object.defineProperty(m,"__esModule",{value:!0}),m})({},vendetta.commands,vendetta.metro);
